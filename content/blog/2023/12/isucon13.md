---
title: "ISUCON13 参加記 Create Speedy Logic（28位 56,881）"
date: "2023-11-25"
math: false
categories:
  - blog
tags:
  - ISUCON
---


[ISUCON13](https://isucon.net/archives/57801192.html)に「Create Speedy Logic」というチームで参加し、最終スコアは56,881点で28位でした。去年に続き２回目の参加になりますが今回も非常に楽しませていただきました。
もっとこうしていればとかはもちろんあるのですが、今回（ライブでの結果発表時では）30位だったので企業賞をもらえたりTOP30チーム入りという結果も残せたので嬉しく思います。

[ISUCON13 受賞チームおよび全チームスコア](https://isucon.net/archives/57993937.html)

### 問題

https://github.com/isucon/isucon13

{{< tweet 1728217027528233173 >}}

スコアが投げ銭の合計！

また単なるパフォーマンスチューニング以外にもDNS水責め攻撃の対応も必要そうとのこと

### 事前の戦略

参加にあたって事前に決めた大まかな戦略は以下でした。
- 初回ベンチマークくらいまでのやることの分担は決めて後は流れで
- 前半~中盤はやることが大きく被らない程度に一人１台使って動作確認・改善していく
- 16:00を過ぎたあたり各自の進捗をみつつサーバーの分割 ※こちらは間に合わず・・・

### やったこと

※自分が関わった部分のみ抜き出したものなのでスコアとスコアの間に他の改善を含む場合があります

| 時間 | スコア | やったことなど |
| :-: | :-: | :--------: |
| 9:00 | --- | 起床 |
| 10:00 | --- | マニュアル読む、コードやDB見る |
| 10:20 | 3,769 | alp設定して初回ベンチをする |
| 11:35 | 12,264 | インデックスを張る |
| 13:30 | 12,264 | ICONのキャッシュ |
| 13:30 | --- | お昼ご飯を食べる |
| 15:00 | 22,349 | usersテーブル全体をキャッシュ |
| 16:55 | 43,184 | livestreams,livestream_tagテーブル全体キャッシュ、fillReactionResponse N+1解消 |
| 17:20 | 48,172 | キャッシュしたテーブルを他の処理にも適用 |
| 17:?? | 56,881 | 上記の変更を別のサーバーで再度実行してもらうとスコアが上がる(最終スコア) |

初動でマニュアルに目を通した後、DBを見てすぐ明らかにインデックスが全然ないことに気付きました。そこで初回ベンチ後はコードを読んでチームメンバーに洗い出してもらった着手できそうな改善アイディアもみつつ必要そうなインデックスを一気に作成しました（+8500くらい）。

インデックスの作成後はこの段階で最も影響がありそうな`GET /api/user/:username/icon`のボトルネック解消のため、第一段階としてICONのキャッシュに取り掛かりました。しかしながらバグらせてしまいベンチマークの整合性チェックで失敗してしばらく唸ることに・・・。13時を超えたあたりでチームメンバーに相談して１行おかしい処理にしてしまっていたためと判明して無事解決しました（1敗）。また苦労した割にこの段階でそれほどスコアは伸びず・・・（+800くらい）。ちなみにこちらは最終的にnginxから返すように変更してもらっています。バグや方針ミスで一番のもったいないポイント。

以降は他メンバーと被らないようにN+1など影響が大きそうな部分が改善できないか見ていきました。users,livestreams, livestream_tagsテーブルがいろんなところで使われているのもあり、キャッシュしつつN+1になっているところとその他利用されているところを修正していきました。ここでもバグを埋め込んで整合性チェックに失敗するようになりそれなりに時間を消化・・・（2敗）。ただ、自明なN+1解消やキャッシュによってシンプルなクエリの発行回数を減らせたのもあってかこちらの改善は合わせて万単位で大きくスコアを伸ばすことができました（もちろん他のメンバーのN+1解消などの改善も効いてきた上での＋だと思います）。

### 環境・ツール

Windows(WSL)環境で参加しました。以下今回主に使ったツール。
- VSCode
- alp（ログ解析用）
- HeidiSQL（DB眺める用）

また今回GitHub Copilotを導入して使ってみました。最近ようやく使い始めたのもあってまだうまく使えているかはわかりませんがコードを書いててそれなりに楽になる場面もあったかなと思います。

### 感想

改めてになりますが問題設定が面白く実際に改善していく過程についても非常に楽しんで参加させていただきました。
反省点としては既存の処理を使いつつ改善していく際にバグを埋め込みがちだった点があります。他にも個人としてDNS周りが手つかずだったのと、中盤に時間を無駄にしてしまう場面もありましたが序盤即インデックス作成したことや終盤にかけてN+1解消やクエリ発行回数削減でそれなりにスコアに貢献できたかなと思います。チームとしてはサーバーの分割が間に合わず結局1台構成となってしまったのは残念でした。
全体的にまだまだ知識や改善の引き出しを増やさないとと感じますが前回参加したときより改善に貢献できたと言えることが増えたのがよかったです。ぜひまた参加したいです。